<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAP MADNESS - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: #0a0a0a;
            color: #00ff00;
            min-height: 100vh;
            padding: 20px;
        }

        /* Scanlines effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255, 255, 0, 0.03) 2px,
                rgba(255, 255, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 3px solid #ffff00;
            background: rgba(255, 255, 0, 0.1);
            border-radius: 10px;
        }

        .title {
            font-size: clamp(2rem, 6vw, 3rem);
            color: #ffff00;
            text-shadow: 0 0 20px #ffff00;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #ffff00; }
            to { text-shadow: 0 0 30px #ffff00, 0 0 40px #ffff00; }
        }

        .subtitle {
            color: #00ffff;
            font-size: 1.2rem;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }

        .status-online {
            color: #00ff00;
        }

        .status-offline {
            color: #ff0080;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            padding: 20px;
            border-radius: 10px;
        }

        .panel h3 {
            color: #00ffff;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #00ffff;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-button {
            background: #ff0080;
            color: #fff;
            border: 2px solid #fff;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
        }

        .admin-button:hover {
            background: #fff;
            color: #ff0080;
            transform: scale(1.05);
        }

        .admin-button.success {
            background: #00ff00;
            color: #000;
        }

        .admin-button.success:hover {
            background: #fff;
            color: #00ff00;
        }

        .admin-button.danger {
            background: #ff4444;
        }

        .admin-button.danger:hover {
            background: #fff;
            color: #ff4444;
        }

        .admin-button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .admin-input {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 10px;
            font-family: 'Orbitron', monospace;
        }

        .admin-input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .log-container {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff00;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #00ff00;
            border-radius: 5px;
        }

        .leaderboard-container {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ffff;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            border-radius: 5px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #333;
            color: #00ff00;
            align-items: center;
        }

        .leaderboard-item:nth-child(1) { color: #ffff00; }
        .leaderboard-item:nth-child(2) { color: #c0c0c0; }
        .leaderboard-item:nth-child(3) { color: #cd7f32; }

        .challenge-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            align-items: center;
        }

        .form-label {
            color: #00ffff;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active { background: #00ff00; }
        .status-completed { background: #ffff00; }
        .status-reset { background: #ff0080; }
        .status-inactive { background: #666; }

        .broadcast-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #333;
        }

        .message-preview {
            background: rgba(255, 0, 128, 0.1);
            border: 2px solid #ff0080;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            color: #ff0080;
            font-weight: bold;
            text-align: center;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status">
        <div>Status: <span id="statusText" class="status-offline">CONNECTING...</span></div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üîß TAP MADNESS ADMIN</h1>
            <p class="subtitle">Control Panel for Tapping Challenges</p>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Challenge Status Panel -->
            <div class="panel">
                <h3>üìä Challenge Status</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="challengeStatus">
                            <span class="status-indicator status-inactive"></span>
                            Loading...
                        </div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="currentGoal">0</div>
                        <div class="stat-label">Goal</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="currentCounter">0</div>
                        <div class="stat-label">Current Taps</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="progressPercent">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                </div>
            </div>

            <!-- Live Stats Panel -->
            <div class="panel">
                <h3>üìà Live Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">Active (5min)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="currentTPS">0</div>
                        <div class="stat-label">Current TPS</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="peakTPS">0</div>
                        <div class="stat-label">Peak TPS</div>
                    </div>
                </div>
            </div>

            <!-- Challenge Controls Panel -->
            <div class="panel">
                <h3>üéÆ Challenge Controls</h3>
                <div class="challenge-form">
                    <div class="form-row">
                        <label class="form-label">Goal:</label>
                        <input type="number" id="newGoal" class="admin-input" value="1000000" min="1000" max="10000000">
                    </div>
                    <div class="form-row">
                        <label class="form-label">Challenge ID:</label>
                        <input type="text" id="challengeId" class="admin-input" placeholder="Auto-generated">
                    </div>
                </div>
                <div class="controls-grid">
                    <button class="admin-button success" onclick="startNewChallenge()">üöÄ Start New Challenge</button>
                    <button class="admin-button" onclick="completeChallenge()">üèÅ Complete Challenge</button>
                    <button class="admin-button danger" onclick="resetChallenge()">üîÑ Reset Challenge</button>
                    <button class="admin-button" onclick="exportData()">üíæ Export Data</button>
                </div>
            </div>

            <!-- Broadcast Panel -->
            <div class="panel">
                <h3>üì¢ Broadcast Message</h3>
                <input type="text" id="broadcastMessage" class="admin-input" placeholder="Enter message to broadcast..." maxlength="100">
                <div id="messagePreview" class="message-preview" style="display: none;"></div>
                <button class="admin-button" onclick="sendBroadcast()">üì° Send Broadcast</button>
                <div class="broadcast-section">
                    <h4 style="color: #00ffff; margin-bottom: 10px;">Quick Messages:</h4>
                    <div class="controls-grid">
                        <button class="admin-button" onclick="quickBroadcast('üî• TAP FASTER BROSKIES!')">üî• Motivate</button>
                        <button class="admin-button" onclick="quickBroadcast('‚ö° COMBO TIME!')">‚ö° Combo</button>
                        <button class="admin-button" onclick="quickBroadcast('üéâ MILESTONE REACHED!')">üéâ Celebrate</button>
                        <button class="admin-button" onclick="quickBroadcast('üí™ KEEP GOING!')">üí™ Encourage</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panels -->
        <div class="dashboard-grid">
            <!-- Top Tappers Panel -->
            <div class="panel">
                <h3>üèÜ Top Tappers (Live)</h3>
                <div id="liveLeaderboard" class="leaderboard-container">
                    Loading...
                </div>
            </div>

            <!-- Activity Log Panel -->
            <div class="panel">
                <h3>üìù Activity Log</h3>
                <div id="activityLog" class="log-container">
                    [SYSTEM] Admin dashboard initialized...<br>
                </div>
                <button class="admin-button" onclick="clearLog()" style="margin-top: 10px;">üóëÔ∏è Clear Log</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQOSW3zIUQHI0qZ5DedfkhwnNSaEew3OQ",
            authDomain: "tap-madness-67ddb.firebaseapp.com",
            databaseURL: "https://tap-madness-67ddb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tap-madness-67ddb",
            storageBucket: "tap-madness-67ddb.firebasestorage.app",
            messagingSenderId: "514868420312",
            appId: "1:514868420312:web:f6604cce0ce8b74d3701ad",
            measurementId: "G-2J3HLFYZVR"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Admin State
        let challenge = {
            status: 'inactive',
            goal: 1000000,
            counter: 0,
            start_time: null,
            end_time: null,
            challenge_id: null
        };
        let adminStats = {
            totalUsers: 0,
            activeUsers: 0,
            currentTPS: 0,
            peakTPS: 0
        };
        let isConnected = false;
        let tpsHistory = [];

        // DOM Elements
        const statusText = document.getElementById('statusText');
        const challengeStatusEl = document.getElementById('challengeStatus');
        const currentGoalEl = document.getElementById('currentGoal');
        const currentCounterEl = document.getElementById('currentCounter');
        const progressPercentEl = document.getElementById('progressPercent');
        const totalUsersEl = document.getElementById('totalUsers');
        const activeUsersEl = document.getElementById('activeUsers');
        const currentTPSEl = document.getElementById('currentTPS');
        const peakTPSEl = document.getElementById('peakTPS');
        const activityLog = document.getElementById('activityLog');
        const liveLeaderboard = document.getElementById('liveLeaderboard');
        const broadcastMessage = document.getElementById('broadcastMessage');
        const messagePreview = document.getElementById('message-preview');
        const newGoalInput = document.getElementById('newGoal');
        const challengeIdInput = document.getElementById('challengeId');

        // Utility Functions
        function logActivity(message) {
            const timestamp = new Date().toLocaleTimeString();
            activityLog.innerHTML += `[${timestamp}] ${message}<br>`;
            activityLog.scrollTop = activityLog.scrollHeight;
        }

        function generateChallengeId() {
            return 'challenge_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function updateStatusIndicator(status) {
            const indicator = challengeStatusEl.querySelector('.status-indicator');
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'active':
                    indicator.classList.add('status-active');
                    challengeStatusEl.innerHTML = '<span class="status-indicator status-active"></span>ACTIVE';
                    break;
                case 'completed':
                    indicator.classList.add('status-completed');
                    challengeStatusEl.innerHTML = '<span class="status-indicator status-completed"></span>COMPLETED';
                    break;
                case 'reset':
                    indicator.classList.add('status-reset');
                    challengeStatusEl.innerHTML = '<span class="status-indicator status-reset"></span>RESET';
                    break;
                default:
                    indicator.classList.add('status-inactive');
                    challengeStatusEl.innerHTML = '<span class="status-indicator status-inactive"></span>INACTIVE';
            }
        }

        // Firebase Listeners
        function setupFirebaseListeners() {
            // Connection monitoring
            database.ref('.info/connected').on('value', (snapshot) => {
                isConnected = snapshot.val();
                if (isConnected) {
                    statusText.textContent = 'ONLINE';
                    statusText.className = 'status-online';
                    logActivity('üü¢ Connection established');
                } else {
                    statusText.textContent = 'OFFLINE';
                    statusText.className = 'status-offline';
                    logActivity('üî¥ Connection lost');
                }
            });

            // Challenge listener
            database.ref('challenge').on('value', (snapshot) => {
                const challengeData = snapshot.val();
                if (challengeData) {
                    const oldStatus = challenge.status;
                    challenge = { ...challenge, ...challengeData };
                    
                    if (oldStatus !== challenge.status) {
                        logActivity(`üìä Challenge status changed: ${oldStatus} ‚Üí ${challenge.status}`);
                    }
                    
                    updateChallengeDisplay();
                } else {
                    challenge = {
                        status: 'inactive',
                        goal: 1000000,
                        counter: 0,
                        start_time: null,
                        end_time: null,
                        challenge_id: null
                    };
                    updateChallengeDisplay();
                }
            });

            // Users listener
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const userCount = Object.keys(users).length;
                
                // Count active users (last active within 5 minutes)
                const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
                const activeUsers = Object.values(users).filter(user => 
                    user.lastActive && user.lastActive > fiveMinutesAgo
                ).length;

                adminStats.totalUsers = userCount;
                adminStats.activeUsers = activeUsers;
                
                updateStatsDisplay();
                updateLeaderboard(users);
            });

            // TPS monitoring
            let lastCounter = 0;
            setInterval(() => {
                const currentTPS = Math.max(0, challenge.counter - lastCounter);
                lastCounter = challenge.counter;
                
                adminStats.currentTPS = currentTPS;
                if (currentTPS > adminStats.peakTPS) {
                    adminStats.peakTPS = currentTPS;
                    if (currentTPS > 10) {
                        logActivity(`üî• New peak TPS: ${currentTPS}`);
                    }
                }
                
                updateStatsDisplay();
            }, 1000);
        }

        function updateChallengeDisplay() {
            updateStatusIndicator(challenge.status);
            currentGoalEl.textContent = challenge.goal.toLocaleString();
            currentCounterEl.textContent = challenge.counter.toLocaleString();
            
            const progress = challenge.goal > 0 ? ((challenge.counter / challenge.goal) * 100).toFixed(1) : 0;
            progressPercentEl.textContent = progress + '%';
            
            if (challenge.challenge_id) {
                challengeIdInput.value = challenge.challenge_id;
            }
        }

        function updateStatsDisplay() {
            totalUsersEl.textContent = adminStats.totalUsers;
            activeUsersEl.textContent = adminStats.activeUsers;
            currentTPSEl.textContent = adminStats.currentTPS;
            peakTPSEl.textContent = adminStats.peakTPS;
        }

        function updateLeaderboard(users) {
            const sortedUsers = Object.entries(users)
                .sort(([,a], [,b]) => b.taps - a.taps)
                .slice(0, 20);

            let leaderboardHTML = '';
            if (sortedUsers.length === 0) {
                leaderboardHTML = '<div style="text-align: center; color: #666;">No users yet...</div>';
            } else {
                sortedUsers.forEach(([user, data], index) => {
                    const isActive = data.lastActive && (Date.now() - data.lastActive) < 300000; // 5 minutes
                    const statusIcon = isActive ? 'üü¢' : 'üî¥';
                    leaderboardHTML += `
                        <div class="leaderboard-item">
                            <span>#${index + 1} ${statusIcon} ${user}</span>
                            <span>${data.taps.toLocaleString()}</span>
                        </div>
                    `;
                });
            }

            liveLeaderboard.innerHTML = leaderboardHTML;
        }

        // Admin Functions
        function startNewChallenge() {
            const goal = parseInt(newGoalInput.value);
            if (!goal || goal < 1000) {
                alert('Please enter a valid goal (minimum 1,000)');
                return;
            }

            if (challenge.status === 'active') {
                if (!confirm('A challenge is currently active. Start a new one anyway?')) {
                    return;
                }
            }

            const challengeId = generateChallengeId();
            const challengeData = {
                status: 'active',
                goal: goal,
                counter: 0,
                start_time: firebase.database.ServerValue.TIMESTAMP,
                end_time: null,
                challenge_id: challengeId
            };

            database.ref('challenge').set(challengeData).then(() => {
                // Clear users for new challenge
                database.ref('users').remove();
                logActivity(`üöÄ New challenge started! Goal: ${goal.toLocaleString()}, ID: ${challengeId}`);
            }).catch((error) => {
                logActivity(`‚ùå Error starting challenge: ${error.message}`);
            });
        }

        function completeChallenge() {
            if (challenge.status !== 'active') {
                alert('No active challenge to complete');
                return;
            }

            database.ref('challenge').update({
                status: 'completed',
                end_time: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                logActivity(`üèÅ Challenge completed! Final count: ${challenge.counter.toLocaleString()}`);
            }).catch((error) => {
                logActivity(`‚ùå Error completing challenge: ${error.message}`);
            });
        }

        function resetChallenge() {
            if (!confirm('‚ö†Ô∏è WARNING: This will completely reset the challenge!\n\nThis action will:\n- Set status to reset\n- Clear all user data\n- Reset counters\n\nAre you absolutely sure?')) {
                return;
            }

            const confirmText = prompt('Type "RESET CHALLENGE" to confirm:');
            if (confirmText !== 'RESET CHALLENGE') {
                alert('Reset cancelled - incorrect confirmation text');
                return;
            }

            // Set status to reset first (this triggers client-side cleanup)
            database.ref('challenge/status').set('reset').then(() => {
                // Wait a moment for clients to react, then clear everything
                setTimeout(() => {
                    database.ref('challenge').remove();
                    database.ref('users').remove();
                    database.ref('broadcast').remove();
                    
                    // Reset admin stats
                    adminStats = {
                        totalUsers: 0,
                        activeUsers: 0,
                        currentTPS: 0,
                        peakTPS: 0
                    };
                    
                    updateStatsDisplay();
                    logActivity('üîÑ Challenge completely reset - all data cleared');
                }, 2000);
            }).catch((error) => {
                logActivity(`‚ùå Error resetting challenge: ${error.message}`);
            });
        }

        function sendBroadcast() {
            const message = broadcastMessage.value.trim();
            if (!message) {
                alert('Please enter a message to broadcast');
                return;
            }

            database.ref('broadcast').set({
                message: message,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                sender: 'ADMIN'
            }).then(() => {
                broadcastMessage.value = '';
                messagePreview.style.display = 'none';
                logActivity(`üì¢ Broadcast sent: "${message}"`);
            }).catch((error) => {
                logActivity(`‚ùå Error sending broadcast: ${error.message}`);
            });
        }

        function quickBroadcast(message) {
            broadcastMessage.value = message;
            sendBroadcast();
        }

        function exportData() {
            database.ref().once('value', (snapshot) => {
                const data = snapshot.val();
                const exportData = {
                    challenge: data.challenge || {},
                    users: data.users || {},
                    stats: adminStats,
                    exportTime: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `tap-madness-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                logActivity('üíæ Data exported successfully');
            }).catch((error) => {
                logActivity(`‚ùå Error exporting data: ${error.message}`);
            });
        }

        function clearLog() {
            activityLog.innerHTML = '[SYSTEM] Activity log cleared...<br>';
        }

        // Event Listeners
        broadcastMessage.addEventListener('input', (e) => {
            const message = e.target.value.trim();
            if (message) {
                messagePreview.textContent = `üì¢ ${message}`;
                messagePreview.style.display = 'block';
            } else {
                messagePreview.style.display = 'none';
            }
        });

        // Initialize
        function init() {
            logActivity('üîß Admin dashboard initializing...');
            setupFirebaseListeners();
            
            // Update displays every 5 seconds
            setInterval(() => {
                updateStatsDisplay();
            }, 5000);
            
            logActivity('‚úÖ Admin dashboard ready');
        }

        init();
    </script>
</body>
</html>
